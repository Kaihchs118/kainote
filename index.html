<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時協作 Markdown 頁面</title>
    <style>
        :root { --bg-color: #121212; --text-color: #e0e0e0; --editor-bg-color: #1e1e1e; --border-color: #333; --link-color: #8ab4f8; --code-bg-color: #2d2d2d; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 2rem; background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; }
        #editor { width: 100%; height: 80vh; background-color: var(--editor-bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; font-size: 16px; line-height: 1.6; box-sizing: border-box; resize: vertical; display: none; font-family: "SF Mono", "Courier New", monospace; }
        #editor:focus { outline: none; border-color: var(--link-color); box-shadow: 0 0 5px rgba(138, 180, 248, 0.5); }
        .markdown-body { line-height: 1.7; word-wrap: break-word; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { border-bottom: 1px solid var(--border-color); padding-bottom: .3em; margin-top: 24px; margin-bottom: 16px; }
        .markdown-body a { color: var(--link-color); text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body code { padding: .2em .4em; margin: 0; font-size: 85%; background-color: var(--code-bg-color); border-radius: 6px; }
        .markdown-body pre { background-color: var(--code-bg-color); padding: 16px; border-radius: 6px; overflow: auto; }
        .markdown-body pre code { background: transparent; }
        .loading-text::before { content: 'Loading content from database...'; color: #777; }
    </style>
</head>
<body>
    <div class="container">
        <div id="content" class="markdown-body loading-text"></div>
        <textarea id="editor" spellcheck="false"></textarea>
    </div>

    <!-- 引入 marked.js 用於 Markdown -> HTML 轉換 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- 引入 Firebase SDK 並執行我們的邏輯 -->
    <script type="module">
        // 1. 從 gstatic.com 引入函式，適合單一 HTML 檔案
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        // 2. 您個人的 Firebase 設定 (已為您填好)
        const firebaseConfig = {
          apiKey: "AIzaSyAKiC62bh50NXLMWwbfNHekmVCBtTtam6Y",
          authDomain: "blog-63ad2.firebaseapp.com",
          // databaseURL 是連接 Realtime Database 的關鍵，已為您填上
          databaseURL: "https://blog-63ad2-default-rtdb.firebaseio.com",
          projectId: "blog-63ad2",
          storageBucket: "blog-63ad2.appspot.com",
          messagingSenderId: "265914768921",
          appId: "1:265914768921:web:e4c752780e604d0be69488"
        };

        // 3. 初始化 Firebase App 與資料庫
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const docRef = ref(database, 'live-doc/content');

        // 4. 取得頁面元素
        const contentDiv = document.getElementById('content');
        const editorTextarea = document.getElementById('editor');

        // 5. 檢查是否為 Admin 模式
        const params = new URLSearchParams(window.location.search);
        const isAdmin = params.get('admin') === '1';

        const defaultText = "# 歡迎！\n\n- 在網址加上 `?admin=1` 進入編輯模式。\n- 內容會即時同步。";
        
        if (isAdmin) {
            editorTextarea.style.display = 'block';
        } else {
            contentDiv.style.display = 'block';
        }

        if (isAdmin) {
            let debounceTimeout;
            editorTextarea.addEventListener('input', () => {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    set(docRef, editorTextarea.value);
                }, 250);
            });
        }

        // 6. 監聽資料庫變化
        onValue(docRef, (snapshot) => {
            const text = snapshot.val();
            const currentContent = text === null ? defaultText : text;

            if (contentDiv.classList.contains('loading-text')) {
                contentDiv.classList.remove('loading-text');
            }

            contentDiv.innerHTML = marked.parse(currentContent);

            if (isAdmin && editorTextarea.value !== currentContent) {
                editorTextarea.value = currentContent;
            }
        });
    </script>
</body>
</html>
